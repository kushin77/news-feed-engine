apiVersion: apps/v1
kind: Deployment
metadata:
  name: news-feed-engine
  namespace: elevatediq
  labels:
    app: news-feed-engine
    tier: backend
    component: ai-processing
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: news-feed-engine
  template:
    metadata:
      labels:
        app: news-feed-engine
        tier: backend
        component: ai-processing
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: news-feed-engine
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001

      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z $POSTGRES_HOST $POSTGRES_PORT; do echo waiting for postgres; sleep 2; done;']
          env:
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: news-feed-engine-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: news-feed-engine-config
                  key: POSTGRES_PORT

        - name: wait-for-kafka
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z $KAFKA_HOST 9092; do echo waiting for kafka; sleep 2; done;']
          env:
            - name: KAFKA_HOST
              valueFrom:
                configMapKeyRef:
                  name: news-feed-engine-config
                  key: KAFKA_HOST

      containers:
        - name: news-feed-engine
          image: gcr.io/elevatediq/news-feed-engine:latest
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: processor
              containerPort: 8081
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP

          envFrom:
            - configMapRef:
                name: news-feed-engine-config
            - secretRef:
                name: news-feed-engine-secrets

          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          volumeMounts:
            - name: config-volume
              mountPath: /app/config
              readOnly: true
            - name: tmp-volume
              mountPath: /tmp

      volumes:
        - name: config-volume
          configMap:
            name: news-feed-engine-config
        - name: tmp-volume
          emptyDir: {}

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: news-feed-engine
                topologyKey: kubernetes.io/hostname

      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: news-feed-engine

---
apiVersion: v1
kind: Service
metadata:
  name: news-feed-engine
  namespace: elevatediq
  labels:
    app: news-feed-engine
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: processor
      port: 8081
      targetPort: 8081
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: news-feed-engine

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: news-feed-engine-config
  namespace: elevatediq
data:
  ELEVATEDIQ_ENVIRONMENT: "production"
  LOG_LEVEL: "info"
  PORT: "8080"
  PROCESSOR_PORT: "8081"
  METRICS_PORT: "9090"

  # Database
  POSTGRES_HOST: "elevatediq-postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "news_feed"
  POSTGRES_SSL: "require"

  # Kafka
  KAFKA_HOST: "elevatediq-kafka"
  KAFKA_BOOTSTRAP_SERVERS: "elevatediq-kafka:9092"
  KAFKA_CONSUMER_GROUP: "news-feed-engine"
  KAFKA_INPUT_TOPIC: "news-feed-raw-content"
  KAFKA_OUTPUT_TOPIC: "news-feed-processed-content"
  KAFKA_VIDEO_TOPIC: "news-feed-video-jobs"
  KAFKA_ANALYTICS_TOPIC: "news-feed-analytics-events"

  # Redis
  REDIS_URL: "redis://elevatediq-redis:6379/1"

  # Media Manager
  MEDIA_MANAGER_URL: "http://media-manager:8080"
  CDN_BASE_URL: "https://cdn.elevatediq.ai"

  # AI Settings
  CLAUDE_MODEL: "claude-3-5-sonnet-20241022"
  CLAUDE_MAX_TOKENS: "4096"
  EMBEDDING_MODEL: "text-embedding-3-small"

  # ElevenLabs
  ELEVENLABS_BASE_URL: "https://api.elevenlabs.io/v1"
  ELEVENLABS_DEFAULT_VOICE: "professional"

  # D-ID
  DID_BASE_URL: "https://api.d-id.com"
  DID_DEFAULT_AVATAR: "professional_anchor"

---
apiVersion: v1
kind: Secret
metadata:
  name: news-feed-engine-secrets
  namespace: elevatediq
type: Opaque
stringData:
  # Note: In production, use External Secrets Operator or Sealed Secrets
  # These are placeholders
  ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
  OPENAI_API_KEY: "${OPENAI_API_KEY}"
  ELEVENLABS_API_KEY: "${ELEVENLABS_API_KEY}"
  DID_API_KEY: "${DID_API_KEY}"
  YOUTUBE_API_KEY: "${YOUTUBE_API_KEY}"
  TWITTER_BEARER_TOKEN: "${TWITTER_BEARER_TOKEN}"
  TIKTOK_CLIENT_SECRET: "${TIKTOK_CLIENT_SECRET}"
  LINKEDIN_CLIENT_SECRET: "${LINKEDIN_CLIENT_SECRET}"
  MEDIA_MANAGER_API_KEY: "${MEDIA_MANAGER_API_KEY}"
  POSTGRES_USER: "${POSTGRES_USER}"
  POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: news-feed-engine
  namespace: elevatediq

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: news-feed-engine
  namespace: elevatediq
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: news-feed-engine
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "100"
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 4
          periodSeconds: 15
      selectPolicy: Max

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: news-feed-engine
  namespace: elevatediq
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: news-feed-engine

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: news-feed-engine
  namespace: elevatediq
spec:
  podSelector:
    matchLabels:
      app: news-feed-engine
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: elevatediq
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: elevatediq
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 9092  # Kafka
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # HTTPS for external APIs
        - protocol: TCP
          port: 80
